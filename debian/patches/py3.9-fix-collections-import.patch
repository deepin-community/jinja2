From: Thomas Goirand <zigo@debian.org>
Date: Wed, 1 Apr 2020 14:08:47 +0200
Subject: Python 3.9: fix collections import

Bug-Debian: https://bugs.debian.org/949018
Forwarded: no
Last-Update: 2020-02-27

As collections has moved to collections.abc, this produces a warning which
may lead to unit testing errors: this is the case when building Rally.

This patch attempts to import from collections.abc, and if it fails, falls
back to collections. This should be harmless.

Note that this patch is probably useless with future version, as hopefully,
upstream will fix it (I didn't check). However, I didn't dare upgrading the
package to the major upstream release 3.x.
---
 src/jinja2/nodes.py   | 5 ++++-
 src/jinja2/sandbox.py | 5 ++++-
 src/jinja2/utils.py   | 5 ++++-
 3 files changed, 12 insertions(+), 3 deletions(-)

diff --git a/src/jinja2/nodes.py b/src/jinja2/nodes.py
index 95bd614..753ecc5 100644
--- a/src/jinja2/nodes.py
+++ b/src/jinja2/nodes.py
@@ -5,7 +5,10 @@
 import inspect
 import operator
 import typing as t
-from collections import deque
+try:
+    from collections.abc import deque
+except ImportError:
+    from collections import deque
 
 from markupsafe import Markup
 
diff --git a/src/jinja2/sandbox.py b/src/jinja2/sandbox.py
index cfd7993..9913966 100644
--- a/src/jinja2/sandbox.py
+++ b/src/jinja2/sandbox.py
@@ -6,7 +6,10 @@
 import typing as t
 from _string import formatter_field_name_split  # type: ignore
 from collections import abc
-from collections import deque
+try:
+    from collections.abc import deque
+except ImportError:
+    from collections import deque
 from string import Formatter
 
 from markupsafe import EscapeFormatter
diff --git a/src/jinja2/utils.py b/src/jinja2/utils.py
index b422ba9..e6c3783 100644
--- a/src/jinja2/utils.py
+++ b/src/jinja2/utils.py
@@ -5,7 +5,10 @@
 import typing as t
 import warnings
 from collections import abc
-from collections import deque
+try:
+    from collections.abc import deque
+except ImportError:
+    from collections import deque
 from random import choice
 from random import randrange
 from threading import Lock
diff --git a/tests/test_utils.py b/tests/test_utils.py
--- a/tests/test_utils.py	2021-09-17 23:24:48.164963520 +0200
+++ b/tests/test_utils.py	2021-09-18 14:38:48.255918195 +0200
@@ -1,6 +1,9 @@
 import pickle
 import random
-from collections import deque
+try:
+    from collections.abc import deque
+except ImportError:
+    from collections import deque
 from copy import copy as shallow_copy
 
 import pytest
diff --git a/src/jinja2/lexer.py b/src/jinja2/lexer.py
--- a/src/jinja2/lexer.py	2021-09-17 23:24:48.164963520 +0200
+++ b/src/jinja2/lexer.py	2021-09-18 14:41:27.236572277 +0200
@@ -6,7 +6,10 @@
 import re
 import typing as t
 from ast import literal_eval
-from collections import deque
+try:
+    from collections.abc import deque
+except ImportError:
+    from collections import deque
 from sys import intern
 
 from ._identifier import pattern as name_re
